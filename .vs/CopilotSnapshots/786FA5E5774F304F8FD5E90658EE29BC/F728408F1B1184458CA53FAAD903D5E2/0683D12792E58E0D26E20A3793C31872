using System;
using System.Windows.Forms;

namespace CourseRegistrationClient
{
    public partial class RegisterForm : Form
    {
        private ClientSocket clientSocket;
        private TextBox txtUsername;
        private TextBox txtPassword;
        private TextBox txtConfirm;
        private TextBox txtFullName;

        public RegisterForm(ClientSocket socket)
        {
            InitializeComponent();
            clientSocket = socket;
            this.Text = "Đăng ký tài khoản - Hệ thống Đăng ký Môn học";
        }

        private void InitializeComponent()
        {
            this.SuspendLayout();

            // Labels
            Label lblUsername = new Label();
            lblUsername.Text = "Tên đăng nhập:";
            lblUsername.Location = new System.Drawing.Point(20, 30);
            lblUsername.Size = new System.Drawing.Size(100, 20);
            lblUsername.Font = new System.Drawing.Font("Segoe UI", 10);
            this.Controls.Add(lblUsername);

            Label lblPassword = new Label();
            lblPassword.Text = "Mật khẩu:";
            lblPassword.Location = new System.Drawing.Point(20, 70);
            lblPassword.Size = new System.Drawing.Size(100, 20);
            lblPassword.Font = new System.Drawing.Font("Segoe UI", 10);
            this.Controls.Add(lblPassword);

            Label lblConfirm = new Label();
            lblConfirm.Text = "Xác nhận mật khẩu:";
            lblConfirm.Location = new System.Drawing.Point(20, 110);
            lblConfirm.Size = new System.Drawing.Size(100, 20);
            lblConfirm.Font = new System.Drawing.Font("Segoe UI", 10);
            this.Controls.Add(lblConfirm);

            Label lblFullName = new Label();
            lblFullName.Text = "Họ tên:";
            lblFullName.Location = new System.Drawing.Point(20, 150);
            lblFullName.Size = new System.Drawing.Size(100, 20);
            lblFullName.Font = new System.Drawing.Font("Segoe UI", 10);
            this.Controls.Add(lblFullName);

            // TextBox
            txtUsername = new TextBox();
            txtUsername.Name = "txtUsername";
            txtUsername.Location = new System.Drawing.Point(130, 30);
            txtUsername.Size = new System.Drawing.Size(200, 20);
            txtUsername.Font = new System.Drawing.Font("Segoe UI", 10);
            this.Controls.Add(txtUsername);

            txtPassword = new TextBox();
            txtPassword.Name = "txtPassword";
            txtPassword.Location = new System.Drawing.Point(130, 70);
            txtPassword.Size = new System.Drawing.Size(200, 20);
            txtPassword.UseSystemPasswordChar = true;
            txtPassword.Font = new System.Drawing.Font("Segoe UI", 10);
            this.Controls.Add(txtPassword);

            txtConfirm = new TextBox();
            txtConfirm.Name = "txtConfirm";
            txtConfirm.Location = new System.Drawing.Point(130, 110);
            txtConfirm.Size = new System.Drawing.Size(200, 20);
            txtConfirm.UseSystemPasswordChar = true;
            txtConfirm.Font = new System.Drawing.Font("Segoe UI", 10);
            this.Controls.Add(txtConfirm);

            txtFullName = new TextBox();
            txtFullName.Name = "txtFullName";
            txtFullName.Location = new System.Drawing.Point(130, 150);
            txtFullName.Size = new System.Drawing.Size(200, 20);
            txtFullName.Font = new System.Drawing.Font("Segoe UI", 10);
            this.Controls.Add(txtFullName);

            // Buttons
            Button btnRegister = new Button();
            btnRegister.Text = "Đăng ký";
            btnRegister.Location = new System.Drawing.Point(130, 190);
            btnRegister.Size = new System.Drawing.Size(95, 30);
            btnRegister.Font = new System.Drawing.Font("Segoe UI", 10);
            btnRegister.Click += BtnRegister_Click;
            this.Controls.Add(btnRegister);

            Button btnCancel = new Button();
            btnCancel.Text = "Hủy";
            btnCancel.Location = new System.Drawing.Point(235, 190);
            btnCancel.Size = new System.Drawing.Size(95, 30);
            btnCancel.Font = new System.Drawing.Font("Segoe UI", 10);
            btnCancel.Click += (s, e) => { this.DialogResult = DialogResult.Cancel; this.Close(); };
            this.Controls.Add(btnCancel);

            this.ClientSize = new System.Drawing.Size(380, 250);
            this.Font = new System.Drawing.Font("Segoe UI", 10);
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.MaximizeBox = false;
            this.MinimizeBox = false;
            this.StartPosition = FormStartPosition.CenterScreen;
            this.ResumeLayout(false);
        }

        private void BtnRegister_Click(object sender, EventArgs e)
        {
            string username = txtUsername.Text.Trim();
            string password = txtPassword.Text;
            string confirm = txtConfirm.Text.Trim();
            string fullName = txtFullName.Text.Trim();

            // Validation
            if (string.IsNullOrEmpty(username) || string.IsNullOrEmpty(password) || string.IsNullOrEmpty(fullName))
            {
                MessageBox.Show("Vui lòng điền đầy đủ thông tin", "Lỗi");
                return;
            }

            if (password != confirm)
            {
                MessageBox.Show("Mật khẩu không trùng khớp", "Lỗi");
                return;
            }

            if (password.Length < 6)
            {
                MessageBox.Show("Mật khẩu phải có ít nhất 6 ký tự", "Lỗi");
                return;
            }

            string response = clientSocket.SendRequest($"REGISTER_USER|{username}|{password}|{fullName}");

            if (response.StartsWith("SUCCESS"))
            {
                MessageBox.Show("Đăng ký thành công!", "Thành công");
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            else
            {
                string errorMsg = response.StartsWith("ERROR") ? response.Substring(6) : response;
                MessageBox.Show("Đăng ký thất bại: " + errorMsg, "Lỗi");
            }
        }
    }
}
