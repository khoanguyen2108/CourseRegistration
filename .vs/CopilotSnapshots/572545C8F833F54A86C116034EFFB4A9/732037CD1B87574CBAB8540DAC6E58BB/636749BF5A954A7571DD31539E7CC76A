using System;
using System.Windows.Forms;
using Newtonsoft.Json;
using System.Collections.Generic;

namespace CourseRegistrationClient
{
    public class AdminForm : Form
    {
        private ClientSocket clientSocket;
        private string userId;
        private string fullName;
        private TabControl tabControl;
        private DataGridView dgvCourses;
        private DataGridView dgvUsers;
        private DataGridView dgvRegistrations;

        public AdminForm(ClientSocket socket, string id, string name)
        {
            clientSocket = socket;
            userId = id;
            fullName = name;
            
            InitializeComponent();
            this.Text = $"Admin - {fullName} - Hệ thống Đăng ký Môn học";
        }

        private void InitializeComponent()
        {
            this.SuspendLayout();

            // Toolbar
            Panel pnlToolbar = new Panel();
            pnlToolbar.Dock = DockStyle.Top;
            pnlToolbar.Height = 50;
            pnlToolbar.BackColor = System.Drawing.SystemColors.Control;
            pnlToolbar.Padding = new Padding(10);
            this.Controls.Add(pnlToolbar);

            Label lblWelcome = new Label();
            lblWelcome.Text = $"Xin chào: {fullName}";
            lblWelcome.Location = new System.Drawing.Point(10, 15);
            lblWelcome.Size = new System.Drawing.Size(300, 25);
            lblWelcome.Font = new System.Drawing.Font("Arial", 12, System.Drawing.FontStyle.Bold);
            pnlToolbar.Controls.Add(lblWelcome);

            Button btnLogout = new Button();
            btnLogout.Text = "Đăng xuất";
            btnLogout.Location = new System.Drawing.Point(850, 12);
            btnLogout.Size = new System.Drawing.Size(90, 30);
            btnLogout.Font = new System.Drawing.Font("Arial", 10);
            btnLogout.Click += (s, e) => { this.DialogResult = DialogResult.Cancel; this.Close(); };
            pnlToolbar.Controls.Add(btnLogout);

            // TabControl
            tabControl = new TabControl();
            tabControl.Dock = DockStyle.Fill;
            tabControl.Font = new System.Drawing.Font("Arial", 10);
            this.Controls.Add(tabControl);

            // Tab 1: Quản lý Môn học
            TabPage tabCourses = new TabPage("Quản lý Môn học");
            CreateCoursesTab(tabCourses);
            tabControl.TabPages.Add(tabCourses);

            // Tab 2: Quản lý Sinh viên
            TabPage tabUsers = new TabPage("Quản lý Sinh viên");
            CreateUsersTab(tabUsers);
            tabControl.TabPages.Add(tabUsers);

            // Tab 3: Xem Đăng ký Sinh viên
            TabPage tabRegistrations = new TabPage("Xem Đăng ký Sinh viên");
            CreateRegistrationsTab(tabRegistrations);
            tabControl.TabPages.Add(tabRegistrations);

            this.ClientSize = new System.Drawing.Size(1000, 700);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.Font = new System.Drawing.Font("Arial", 10);
            this.ResumeLayout(false);

            Console.WriteLine("[CLIENT] Loading courses data...");
            LoadCoursesData();
            Console.WriteLine("[CLIENT] Loading users data...");
            LoadUsersData();
            Console.WriteLine("[CLIENT] Loading registrations data...");
            LoadRegistrationsData();
            Console.WriteLine("[CLIENT] Data loaded successfully");
        }

        private void CreateCoursesTab(TabPage tab)
        {
            // Panel thêm môn
            Panel pnlAdd = new Panel();
            pnlAdd.Dock = DockStyle.Top;
            pnlAdd.Height = 70;
            pnlAdd.BorderStyle = BorderStyle.FixedSingle;
            pnlAdd.Padding = new Padding(10);
            tab.Controls.Add(pnlAdd);

            int xPos = 10;
            Label[] labels = new Label[4];
            TextBox[] textboxes = new TextBox[4];
            string[] labelTexts = { "Mã môn:", "Tên môn:", "Tín chỉ:", "Chỗ trống:" };

            for (int i = 0; i < 4; i++)
            {
                labels[i] = new Label();
                labels[i].Text = labelTexts[i];
                labels[i].Location = new System.Drawing.Point(xPos, 10);
                labels[i].Size = new System.Drawing.Size(80, 20);
                labels[i].Font = new System.Drawing.Font("Arial", 9);
                pnlAdd.Controls.Add(labels[i]);

                textboxes[i] = new TextBox();
                textboxes[i].Name = "txt" + i;
                textboxes[i].Location = new System.Drawing.Point(xPos, 33);
                textboxes[i].Size = new System.Drawing.Size(100, 25);
                textboxes[i].Font = new System.Drawing.Font("Arial", 10);
                pnlAdd.Controls.Add(textboxes[i]);

                xPos += 120;
            }

            Button btnAddCourse = new Button();
            btnAddCourse.Text = "Thêm Môn";
            btnAddCourse.Location = new System.Drawing.Point(500, 33);
            btnAddCourse.Size = new System.Drawing.Size(100, 25);
            btnAddCourse.Font = new System.Drawing.Font("Arial", 10);
            btnAddCourse.Click += (s, e) => BtnAddCourse_Click(textboxes);
            pnlAdd.Controls.Add(btnAddCourse);

            // DataGridView
            dgvCourses = new DataGridView();
            dgvCourses.Dock = DockStyle.Fill;
            dgvCourses.AutoGenerateColumns = false;
            dgvCourses.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
            dgvCourses.AllowUserToAddRows = false;
            dgvCourses.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            dgvCourses.Font = new System.Drawing.Font("Arial", 10);

            dgvCourses.Columns.Add("CourseId", "Mã môn");
            dgvCourses.Columns[0].Width = 80;
            
            dgvCourses.Columns.Add("CourseName", "Tên môn");
            dgvCourses.Columns[1].Width = 200;
            
            dgvCourses.Columns.Add("Credits", "Tín chỉ");
            dgvCourses.Columns[2].Width = 80;
            
            dgvCourses.Columns.Add("AvailableSlots", "Chỗ trống");
            dgvCourses.Columns[3].Width = 100;

            // Context menu
            ContextMenuStrip cmsDelete = new ContextMenuStrip();
            ToolStripMenuItem deleteItem = new ToolStripMenuItem("Xóa môn");
            deleteItem.Click += (s, e) => BtnDeleteCourse_Click();
            cmsDelete.Items.Add(deleteItem);
            dgvCourses.ContextMenuStrip = cmsDelete;

            tab.Controls.Add(dgvCourses);
        }

        private void CreateUsersTab(TabPage tab)
        {
            // Panel thêm sinh viên
            Panel pnlAdd = new Panel();
            pnlAdd.Dock = DockStyle.Top;
            pnlAdd.Height = 70;
            pnlAdd.BorderStyle = BorderStyle.FixedSingle;
            pnlAdd.Padding = new Padding(10);
            tab.Controls.Add(pnlAdd);

            Label lblUsername = new Label();
            lblUsername.Text = "Tên ĐN:";
            lblUsername.Location = new System.Drawing.Point(10, 10);
            lblUsername.Size = new System.Drawing.Size(80, 20);
            lblUsername.Font = new System.Drawing.Font("Arial", 9);
            pnlAdd.Controls.Add(lblUsername);

            TextBox txtUsername = new TextBox();
            txtUsername.Name = "txtUsername";
            txtUsername.Location = new System.Drawing.Point(10, 33);
            txtUsername.Size = new System.Drawing.Size(100, 25);
            txtUsername.Font = new System.Drawing.Font("Arial", 10);
            pnlAdd.Controls.Add(txtUsername);

            Label lblPassword = new Label();
            lblPassword.Text = "Mật khẩu:";
            lblPassword.Location = new System.Drawing.Point(120, 10);
            lblPassword.Size = new System.Drawing.Size(80, 20);
            lblPassword.Font = new System.Drawing.Font("Arial", 9);
            pnlAdd.Controls.Add(lblPassword);

            TextBox txtPassword = new TextBox();
            txtPassword.Name = "txtPassword";
            txtPassword.Location = new System.Drawing.Point(120, 33);
            txtPassword.Size = new System.Drawing.Size(100, 25);
            txtPassword.UseSystemPasswordChar = true;
            txtPassword.Font = new System.Drawing.Font("Arial", 10);
            pnlAdd.Controls.Add(txtPassword);

            Label lblFullName = new Label();
            lblFullName.Text = "Họ tên:";
            lblFullName.Location = new System.Drawing.Point(230, 10);
            lblFullName.Size = new System.Drawing.Size(80, 20);
            lblFullName.Font = new System.Drawing.Font("Arial", 9);
            pnlAdd.Controls.Add(lblFullName);

            TextBox txtFullName = new TextBox();
            txtFullName.Name = "txtFullName";
            txtFullName.Location = new System.Drawing.Point(230, 33);
            txtFullName.Size = new System.Drawing.Size(150, 25);
            txtFullName.Font = new System.Drawing.Font("Arial", 10);
            pnlAdd.Controls.Add(txtFullName);

            Button btnAdd = new Button();
            btnAdd.Text = "Thêm";
            btnAdd.Location = new System.Drawing.Point(400, 33);
            btnAdd.Size = new System.Drawing.Size(100, 25);
            btnAdd.Font = new System.Drawing.Font("Arial", 10);
            btnAdd.Click += (s, e) => BtnAddUser_Click(txtUsername, txtPassword, txtFullName);
            pnlAdd.Controls.Add(btnAdd);

            // DataGridView
            dgvUsers = new DataGridView();
            dgvUsers.Dock = DockStyle.Fill;
            dgvUsers.AutoGenerateColumns = false;
            dgvUsers.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
            dgvUsers.AllowUserToAddRows = false;
            dgvUsers.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            dgvUsers.Font = new System.Drawing.Font("Arial", 10);

            dgvUsers.Columns.Add("UserId", "ID");
            dgvUsers.Columns[0].Width = 100;
            
            dgvUsers.Columns.Add("Username", "Tên đăng nhập");
            dgvUsers.Columns[1].Width = 150;
            
            dgvUsers.Columns.Add("FullName", "Họ tên");
            dgvUsers.Columns[2].Width = 200;
            
            dgvUsers.Columns.Add("Role", "Quyền");
            dgvUsers.Columns[3].Width = 100;

            // Context menu
            ContextMenuStrip cms = new ContextMenuStrip();
            ToolStripMenuItem delete = new ToolStripMenuItem("Xóa");
            delete.Click += (s, e) => BtnDeleteUser_Click();
            cms.Items.Add(delete);
            dgvUsers.ContextMenuStrip = cms;

            tab.Controls.Add(dgvUsers);
        }

        private void CreateRegistrationsTab(TabPage tab)
        {
            // DataGridView for registrations
            dgvRegistrations = new DataGridView();
            dgvRegistrations.Dock = DockStyle.Fill;
            dgvRegistrations.AutoGenerateColumns = false;
            dgvRegistrations.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
            dgvRegistrations.AllowUserToAddRows = false;
            dgvRegistrations.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            dgvRegistrations.Font = new System.Drawing.Font("Arial", 10);

            dgvRegistrations.Columns.Add("RegistrationId", "ID đăng ký");
            dgvRegistrations.Columns[0].Width = 100;
            
            dgvRegistrations.Columns.Add("UserId", "ID sinh viên");
            dgvRegistrations.Columns[1].Width = 100;
            
            dgvRegistrations.Columns.Add("CourseId", "Mã môn");
            dgvRegistrations.Columns[2].Width = 80;
            
            dgvRegistrations.Columns.Add("CourseName", "Tên môn");
            dgvRegistrations.Columns[3].Width = 200;
            
            dgvRegistrations.Columns.Add("Credits", "Tín chỉ");
            dgvRegistrations.Columns[4].Width = 80;
            
            dgvRegistrations.Columns.Add("Semester", "Học kỳ");
            dgvRegistrations.Columns[5].Width = 100;

            tab.Controls.Add(dgvRegistrations);
        }

        private void BtnAddCourse_Click(TextBox[] textboxes)
        {
            string courseId = textboxes[0].Text.Trim();
            string courseName = textboxes[1].Text.Trim();
            string credits = textboxes[2].Text.Trim();
            string slots = textboxes[3].Text.Trim();

            if (string.IsNullOrEmpty(courseId) || string.IsNullOrEmpty(courseName) || 
                string.IsNullOrEmpty(credits) || string.IsNullOrEmpty(slots))
            {
                MessageBox.Show("Vui lòng điền đầy đủ thông tin", "Lỗi");
                return;
            }

            string response = clientSocket.SendRequest($"ADD_COURSE|{courseId}|{courseName}|{credits}|{slots}");
            if (response.StartsWith("SUCCESS"))
            {
                MessageBox.Show("Thêm môn thành công", "Thành công");
                LoadCoursesData();
                foreach (var txt in textboxes) txt.Clear();
            }
            else
            {
                MessageBox.Show("Lỗi: " + response, "Lỗi");
            }
        }

        private void BtnDeleteCourse_Click()
        {
            if (dgvCourses.SelectedRows.Count == 0)
            {
                MessageBox.Show("Vui lòng chọn môn cần xóa", "Lỗi");
                return;
            }

            string courseId = dgvCourses.SelectedRows[0].Cells[0].Value.ToString();
            if (MessageBox.Show($"Xóa môn {courseId}?", "Xác nhận", MessageBoxButtons.YesNo) == DialogResult.Yes)
            {
                string response = clientSocket.SendRequest($"DELETE_COURSE|{courseId}");
                if (response.StartsWith("SUCCESS"))
                {
                    MessageBox.Show("Xóa thành công", "Thành công");
                    LoadCoursesData();
                }
            }
        }

        private void BtnAddUser_Click(TextBox txtUsername, TextBox txtPassword, TextBox txtFullName)
        {
            string username = txtUsername.Text.Trim();
            string password = txtPassword.Text;
            string fullName = txtFullName.Text.Trim();

            if (string.IsNullOrEmpty(username) || string.IsNullOrEmpty(password) || string.IsNullOrEmpty(fullName))
            {
                MessageBox.Show("Vui lòng điền đầy đủ thông tin", "Lỗi");
                return;
            }

            string response = clientSocket.SendRequest($"REGISTER_USER|{username}|{password}|{fullName}");
            if (response.StartsWith("SUCCESS"))
            {
                MessageBox.Show("Thêm sinh viên thành công", "Thành công");
                LoadUsersData();
                txtUsername.Clear();
                txtPassword.Clear();
                txtFullName.Clear();
            }
            else
            {
                MessageBox.Show("Lỗi: " + response, "Lỗi");
            }
        }

        private void BtnDeleteUser_Click()
        {
            if (dgvUsers.SelectedRows.Count == 0)
            {
                MessageBox.Show("Vui lòng chọn sinh viên cần xóa", "Lỗi");
                return;
            }

            string userId = dgvUsers.SelectedRows[0].Cells[0].Value.ToString();
            string userName = dgvUsers.SelectedRows[0].Cells[1].Value.ToString();

            if (MessageBox.Show($"Xóa sinh viên {userName}?", "Xác nhận", MessageBoxButtons.YesNo) == DialogResult.Yes)
            {
                string response = clientSocket.SendRequest($"DELETE_USER|{userId}");
                if (response.StartsWith("SUCCESS"))
                {
                    MessageBox.Show("Xóa thành công", "Thành công");
                    LoadUsersData();
                }
                else
                {
                    MessageBox.Show("Lỗi: " + response, "Lỗi");
                }
            }
        }

        private void LoadCoursesData()
        {
            if (dgvCourses == null)
            {
                Console.WriteLine("[ERROR] dgvCourses is null");
                return;
            }

            string response = clientSocket.SendRequest("VIEW_COURSES");
            dgvCourses.Rows.Clear();

            if (response.StartsWith("SUCCESS"))
            {
                try
                {
                    string json = response.Substring(8);
                    dynamic courses = JsonConvert.DeserializeObject(json);
                    foreach (var course in courses)
                    {
                        dgvCourses.Rows.Add(
                            course["CourseId"],
                            course["CourseName"],
                            course["Credits"],
                            course["AvailableSlots"]
                        );
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[ERROR] LoadCoursesData: {ex.Message}");
                }
            }
        }

        private void LoadUsersData()
        {
            if (dgvUsers == null)
            {
                Console.WriteLine("[ERROR] dgvUsers is null");
                return;
            }

            string response = clientSocket.SendRequest("GET_ALL_USERS");
            dgvUsers.Rows.Clear();

            if (response.StartsWith("SUCCESS"))
            {
                try
                {
                    string json = response.Substring(8);
                    if (json.Trim() != "[]")
                    {
                        dynamic users = JsonConvert.DeserializeObject(json);
                        foreach (var user in users)
                        {
                            dgvUsers.Rows.Add(
                                user["UserId"],
                                user["Username"],
                                user["FullName"],
                                user["Role"]
                            );
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[ERROR] LoadUsersData: {ex.Message}");
                }
            }
        }

        private void LoadRegistrationsData()
        {
            if (dgvRegistrations == null)
            {
                Console.WriteLine("[ERROR] dgvRegistrations is null");
                return;
            }

            string response = clientSocket.ViewAllRegistrations();
            dgvRegistrations.Rows.Clear();

            if (response.StartsWith("SUCCESS"))
            {
                try
                {
                    string json = response.Substring(8);
                    dynamic registrations = JsonConvert.DeserializeObject(json);
                    foreach (var reg in registrations)
                    {
                        dgvRegistrations.Rows.Add(
                            reg["RegistrationId"],
                            reg["UserId"],
                            reg["CourseId"],
                            reg["CourseName"],
                            reg["Credits"],
                            reg["Semester"]
                        );
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[ERROR] LoadRegistrationsData: {ex.Message}");
                }
            }
        }
    }
}
